<template>
    <div style="position: relative; height: 100%; width: 100%; z-index: 1;">
        <div id="cytoscape_id" style="height: 100%; width: 100%; z-index: 2;"></div>
        <div id="cytoolbar_id" style="position: absolute; left: 5pt; top: 5pt; z-index: 2; background-color: #658885;">
            <div class="tools">
                <div class="center-center">
                    <Icon style="font-size: 32px; cursor: pointer;" title="ÊîæÂ§ß" type="ios-add-circle-outline"
                          @click="magnifying()"/>
                </div>
            </div>
            <div class="tools">
                <div class="center-center">
                    <Icon style="font-size: 32px; cursor: pointer;" title="Áº©Â∞è" type="ios-remove-circle-outline"
                          @click="contractible()"/>
                </div>
            </div>
            <div class="tools">
                <div class="center-center">
                    <Icon style="font-size: 32px; cursor: pointer;" title="ÂêàÈÄÇÂ§ßÂ∞è" type="ios-resize" @click="resize()"/>
                </div>
            </div>
            <div class="tools">
                <div class="center-center">
                    <Icon style="font-size: 32px; cursor: pointer;" title="È´ò‰∫ÆÈÇªÂ±Ö" type="ios-color-wand-outline"
                          @click="highlight()"/>
                </div>
            </div>
            <div class="tools">
                <div class="center-center">
                    <Icon style="font-size: 32px; cursor: pointer;" title="Âà∑Êñ∞Â∏ÉÂ±Ä" type="ios-sync"
                          @click="refresh({name: 'cola'})"/>
                </div>
            </div>
            <div class="tools">
                <div class="center-center">
                    <Icon style="font-size: 32px; cursor: pointer;" title="ÁΩëÊ†ºÂ∏ÉÂ±Ä" type="ios-apps-outline"
                          @click="refresh({name: 'grid'})"/>
                </div>
            </div>
            <div class="tools">
                <div class="center-center">
                    <Icon style="font-size: 32px; cursor: pointer;" title="ÁéØÂΩ¢Â∏ÉÂ±Ä" type="ios-globe-outline"
                          @click="refresh({name: 'circle'})"/>
                </div>
            </div>
        </div>
        <div class="tips" style="z-index: 3;position: absolute; left: 5pt; top: 50pt" v-if="!issueCardVisible">
            <span style="color: #42b983">üí°You can long press the node to get more information.</span>
        </div>
        <div class="issue-cards" v-if="issueCardVisible">
            <Card style="width:400px;z-index: 3;position: absolute; left: 5pt; top: 50pt">
                <p slot="title">
                    <Icon type="ios-bug-outline"/>
                    Issue Detail
                </p>
                <a href="#" slot="extra" @click.prevent="closeIssue">
                    <Icon type="ios-close"/>
                </a>
                <div class="card-content" style="height: 400px">
                    <span>{{this.relationIssueInf.title}}</span>
                    <div class="markdown1" style="margin-top: 10px">
                        <mavon-editor
                                :value="this.relationIssueInf.description"
                                defaultOpen="preview"
                                :boxShadow="false"
                                previewBackground="#354A51"
                                style="z-index:1;height:350px;border: 1px solid #d9d9d9;color: #fff"
                                :editable="false"
                                :subfield="false"
                                :toolbarsFlag="false"
                                :externalLink="false"
                        >
                        </mavon-editor>
                    </div>

                </div>

            </Card>
        </div>
    </div>
</template>

<script>
    import cytoscape from 'cytoscape';
    import cxtmenu from 'cytoscape-cxtmenu';
    import cola from 'cytoscape-cola';
    import avsdf from 'cytoscape-avsdf';
    import coseBilkent from 'cytoscape-cose-bilkent';
    import {mapActions, mapGetters, mapMutations} from "vuex";

    export default {
        name: "CJS",
        components: {},
        beforeCreate() {
            this.$cy && this.$cy.destroyed() && this.$cy.destroy();
            delete this.$cy;
        },
        beforeDestroy() {
            this.$cy && this.$cy.destroyed() && this.$cy.destroy();
            delete this.$cy;
        },
        watch: {},
        props: {},
        mounted() {
            this.set_issueCardVisible(false);
            this.set_relationIssueInf(null);
            // CxtmenuÂúÜÂΩ¢ËèúÂçï‰∏ªË¶Å‰æùËµñÁªÑ‰ª∂
            if (!cytoscape().cxtmenu) {
                cytoscape.use(cxtmenu);
                cytoscape.use(cola);
                cytoscape.use(avsdf);
                cytoscape.use(coseBilkent);
            }
            this.$cy = cytoscape({
                // initial viewport state:
                zoom: 1,
                pan: {x: 0, y: 0},
                minZoom: 1e-50,
                maxZoom: 1e50,
                zoomingEnabled: true,
                userZoomingEnabled: true,
                panningEnabled: true,
                userPanningEnabled: true,
                boxSelectionEnabled: true,
                selectionType: 'single',
                touchTapThreshold: 8,
                desktopTapThreshold: 4,
                autolock: false,
                autoungrabify: false,
                autounselectify: false,
                headless: false,
                styleEnabled: true,
                hideEdgesOnViewport: true,
                hideLabelsOnViewport: true,
                textureOnViewport: true,
                motionBlur: true,
                motionBlurOpacity: 0.2,
                wheelSensitivity: 0.3,
                pixelRatio: 'auto',
                container: document.getElementById('cytoscape_id'),
                // ‰∏Ä‰∏™ÊåáÂÆöÂ∏ÉÂ±ÄÈÄâÈ°πÁöÑÊôÆÈÄöÂØπË±°.
                layout: {name: 'random'},
            });
            // CxtmenuÂúÜÂΩ¢ËèúÂçï--ÂºÄÂßã
            this.$cy.cxtmenu({
                menuRadius: 80,
                selector: 'node',
                // eslint-disable-next-line no-unused-vars
                commands: (element) => {
                    return [
                        {
                            fillColor: 'rgba(200, 200, 200, 0.75)',
                            content: '<span class="fa fa-flash fa-2x">Detail</span>',
                            contentStyle: {},
                            select: (ele) => this.getIssueInf([ele.id()]),
                            enabled: true,
                        },

                        {
                            content: 'Highlight',
                            select: (ele) => this.lightOn([ele.id()]),
                            enabled: true,
                        },
                    ]
                },
                fillColor: '#658885', activeFillColor: '#49A8AC',
                activePadding: 10, indicatorSize: 14,
                separatorWidth: 4, spotlightPadding: 10,
                minSpotlightRadius: 10, maxSpotlightRadius: 14,
                openMenuEvents: 'cxttapstart taphold',
                itemColor: 'white', itemTextShadowColor: '#354A51',
                zIndex: 9999, atMouse: true,
            });
            //CxtmenuÂúÜÂΩ¢ËèúÂçï--ÁªìÊùü
            // ‰∏çÂêåËäÇÁÇπÁöÑÊ†∑Âºè
            this.$cy
                .style()
                .selector('.issue')
                .css({
                    'background-color': '#49A8AC',
                    'content': 'data(name)',
                    'border-color': '#49A8AC',
                    'border-width': "5px"
                })
                .selector('.classes-B')
                .css({
                    'background-color': '#b88cea',
                    'content': 'data(name)',
                    'border-color': '#b88cea',
                    'border-width': "5px"
                })
                // // .style({'background-color': '#00FF00', 'border-color': '#00FF00', 'border-width': "1px",})
                .selector('.classes-C')
                // // .style({'background-color': '#0000FF', 'border-color': '#0000FF', 'border-width': "1px",})
                .css({
                    'background-color': '#77c94f',
                    'content': 'data(name)',
                    'border-color': '#77c94f',
                    'border-width': "5px"
                })
                .selector('.classes-D')
                .css({
                    'background-color': '#fcb16f',
                    'content': 'data(name)',
                    'border-color': '#fcb16f',
                    'border-width': "5px"
                })
                .selector('.relation')
                .css({
                    'target-arrow-color': '#999999', /*ÁÆ≠Â§¥È¢úËâ≤*/
                    'curve-style': 'bezier', /*Á∫øÊù°Ê†∑ÂºèÊõ≤Á∫ø*/
                    'line-color': '#999999', /*Á∫øÊù°È¢úËâ≤*/
                    'width': '1px', /*Á∫øÊù°ÂÆΩÂ∫¶*/
                })
                .selector('.relationB')
                .css({
                    'line-style': 'dotted',
                    'target-arrow-color': '#999999', /*ÁÆ≠Â§¥È¢úËâ≤*/
                    'curve-style': 'bezier', /*Á∫øÊù°Ê†∑ÂºèÊõ≤Á∫ø*/
                    'line-color': '#999999', /*Á∫øÊù°È¢úËâ≤*/
                    'line-dash-offset': '1',
                    'width': '1px', /*Á∫øÊù°ÂÆΩÂ∫¶*/
                })
            ;
            // ÈÄöÁî®ÁöÑÊ†∑Âºè
            this.$cy.style()
                /*Êú™ÈÄâÊã©ËäÇÁÇπÊ†∑Âºè*/
                .selector('node')
                .style({
                    'label': 'data(name)',
                    'font-size': '10pt',
                    'width': '8pt',
                    'height': '8pt',
                    'color': '#DBF5E0',
                })
                /*Â∑≤ÈÄâÊã©ËäÇÁÇπÊ†∑Âºè*/
                .selector('node:selected')
                .style({'border-color': '#c84e40', 'border-width': "1px",})
                /*Êú™ÈÄâÊã©ËäÇÁÇπÊ†∑Âºè*/
                .selector('edge')
                .style({
                    'label': 'data(name)',
                    'target-arrow-shape': 'triangle-backcurve', /*ÁÆ≠Â§¥Ê†∑Âºè*/
                    'target-arrow-size': '1px', /*ÁÆ≠Â§¥Â§ßÂ∞è*/
                    'target-arrow-color': '#999999', /*ÁÆ≠Â§¥È¢úËâ≤*/
                    'curve-style': 'bezier', /*Á∫øÊù°Ê†∑ÂºèÊõ≤Á∫ø*/
                    'line-color': '#999999', /*Á∫øÊù°È¢úËâ≤*/
                    'width': '1px', /*Á∫øÊù°ÂÆΩÂ∫¶*/
                    'font-size': '10px', /*Ê†áÁ≠æÂ≠ó‰ΩìÂ§ßÂ∞è*/
                    'color': '#658885', /*Ê†áÁ≠æÂ≠ó‰ΩìÂ§ßÂ∞è*/
                    'text-outline-color': 'white', /*ÊñáÊú¨ËΩÆÂªìÈ¢úËâ≤*/
                    'text-outline-width': '1px', /*ÊñáÊú¨ËΩÆÂªìÂÆΩÂ∫¶*/
                    'text-rotation': 'autorotate', /*Ê†áÁ≠æÊñπÂêë*/
                })
                /*Â∑≤ÈÄâÊã©ËäÇÁÇπÊ†∑Âºè*/
                .selector('edge:selected')
                .style({
                    'color': '#3165fc', /*Ê†áÁ≠æÂ≠ó‰ΩìÂ§ßÂ∞è*/
                    'target-arrow-color': '#61bffc', /*ÁÆ≠Â§¥È¢úËâ≤*/
                    'line-color': '#61bffc', /*Á∫øÊù°È¢úËâ≤*/
                })
                /*È´ò‰∫ÆÊ†∑Âºè*/
                .selector('.light-off')
                .style({'opacity': '0.1',})
            ;
        },
        data() {
            return {}
        },
        computed: {
            ...mapGetters([
                'relationIssueInf',
                'issueCardVisible'
            ])
        },
        methods: {
            ...mapMutations([
                'set_currentIssueId',
                'set_relationIssueInf',
                'set_issueCardVisible'
            ]),
            ...mapActions([
                'relationGetIssueDetailById'
            ]),

            /**
             * eles : Array or Map.
             * node_eg: {group: 'nodes', data: {id: 'nid1', name: 'name1', label: 'l1 l2', others: 'others'}, classes: 'like label', position: {x: 100, y: 100}};
             * edge_eg: {group: 'edges', data: {id: 'eid1', name: 'name1', source: 'A', target: 'B', label: 'l1 l2', others: 'others'}, classes: 'like label', position: {x: 100, y: 100}};
             * node_eg: [
             *   {group: 'nodes', data: {id: 'nid1', name: 'name1', label: 'l1 l2', others: 'others'}, classes: 'like label', position: {x: 100, y: 100}};
             *   {group: 'nodes', data: {id: 'nid2', name: 'name2', label: 'l1 l2', others: 'others'}, classes: 'like label', position: {x: 100, y: 100}};
             * ];
             * edge_eg: [
             *   {group: 'edges', data: {id: 'eid1', name: 'name1', source: 'nid1', target: 'nid2', label: 'l1 l2', others: 'others'}, classes: 'like label', position: {x: 100, y: 100}};
             *   {group: 'edges', data: {id: 'eid2', name: 'name1', source: 'nid2', target: 'nid3', label: 'l1 l2', others: 'others'}, classes: 'like label', position: {x: 100, y: 100}};
             * ];
             * @param eles ÂÖÉÁ¥†ÈõÜÂêà.
             */

            /**
             * Â¢ûÂä†ËäÇÁÇπ
             */
            addEles(eles) {
                if (eles) {
                    this.$cy.startBatch();
                    this.$cy.batch(() => {
                        let elements = ((Array.isArray ? Array.isArray(eles) : null != eles && eles instanceof Array) ? eles : [eles]);
                        let filterElements = elements.filter(__ => !this.$cy.getElementById(__.data.id).length);
                        this.$cy.add(filterElements);
                        this.refresh();
                    });
                    this.$cy.endBatch();
                }
            },
            /**
             * Âà†Èô§ÈÄâÊã©ÁöÑÂÜÖÂÆπ(ÂèØËÉΩÊòØÈ°∂ÁÇπ, ‰πüÂèØËÉΩÊòØÂÖ≥Á≥ª)
             */
            delEles() {
                this.$cy.startBatch();
                this.$cy.batch(() => {
                    let selectedEles = this.$cy.elements(':selected');
                    // Êú™ÈÄâÊã©‰∏çËøõË°åÊìç‰Ωú
                    if (!selectedEles || 1 > selectedEles.length) {
                        return false;
                    }
                    selectedEles.remove();
                });
                this.$cy.endBatch();
            },
            /**
             *  Â±ïÁ§∫issueÂÖ∑‰ΩìÂÜÖÂÆπ
             **/
            async getIssueInf(ele) {
                let element = this.$cy.getElementById(ele);
                let id = element.data().id;
                await this.set_currentIssueId(id);
                await this.relationGetIssueDetailById();
            },
            closeIssue() {
                this.set_relationIssueInf(null);
                this.set_issueCardVisible(false);
            },
            /***************************Â∑•ÂÖ∑Ê†è************************/
            /**
             * Áº©ÊîæÂ§ßÂ∞è.
             * @param zoom Â¢ûÂáèÂπÖÂ∫¶.
             */
            zoom(zoom) {
                /** Ëé∑ÂèñÂ∑≤ÈÄâÊã©ÂÜÖÂÆπ */
                let selectedEles = this.$cy.elements('node:selected');
                let selectedEle = selectedEles && selectedEles.length ? selectedEles[0] : null;
                let pan = this.$cy.pan();
                let [x, y] = selectedEle ? [selectedEle.position('x'), selectedEle.position('y')] : [pan.x, pan.y];
                let level = this.$cy.zoom() + zoom;
                (level > this.$cy.maxZoom) && (level = this.$cy.maxZoom);
                (level < this.$cy.minZoom) && (level = this.$cy.minZoom);
                this.$cy.zoom({level: level, renderedPosition: {x: x, y: y}});
            },
            /** ÊîæÂ§ß */
            magnifying() {
                this.zoom(0.3);
            },
            /** Áº©Â∞è */
            contractible() {
                this.zoom(-0.3);
            },
            /** ÂêàÈÄÇÂ§ßÂ∞è */
            resize() {
                this.$cy.fit();
            },
            /**
             * È´ò‰∫Æ.
             * @param ele ÊüêÂÖÉÁ¥†ID
             */
            lightOn(ele) {
                this.$cy.startBatch();
                this.$cy.batch(() => {
                    this.$cy.elements().addClass("light-off"); //*Ê∑ªÂä†Ê†∑Âºè*/
                    let elements = ((Array.isArray ? Array.isArray(ele) : null != ele && ele instanceof Array) ? ele : [ele]);
                    elements.forEach(__ => {
                        this.$cy.getElementById(__).removeClass("light-off");
                        this.$cy.getElementById(__).neighborhood().removeClass("light-off");
                    });
                });
                this.$cy.once('click', () => this.lightOff());
                this.$cy.endBatch();
            },
            /**
             * ÂèñÊ∂àÈ´ò‰∫Æ.
             */
            lightOff() {
                this.$cy.startBatch();
                this.$cy.batch(() => this.$cy.elements().removeClass("light-off") /*ÁßªÈô§Ê†∑Âºè*/);
                this.$cy.endBatch();
            },
            /** È´ò‰∫ÆÈÇªÂ±Ö */
            highlight() {
                /** Ëé∑ÂèñÂ∑≤ÈÄâÊã©ÂÜÖÂÆπ */
                let selectedEles = this.$cy.elements('node:selected');
                /** Ëé∑ÂèñÂ∑≤ÈÄâÊã©ÂÜÖÂÆπ‰∏≠ÂæóÁ¨¨‰∏Ä‰∏™, Ê≤°ÊúâÈÄâÊã©‰∏∫null */
                let selectedEle = selectedEles && selectedEles.length ? selectedEles[0] : null;
                (selectedEle) && (this.lightOn(selectedEle.id()));
            },
            /**
             * Âà∑Êñ∞Â∏ÉÂ±Ä.
             * nameÂèñÂÄºËåÉÂõ¥:
             * ['grid', 'circle', 'cola', 'avsdf', 'cose-bilkent', ]
             * @param {name = 'cola......', randomize = true | false, animate = true | false}
             */
            refresh({name = 'cola', randomize = false, animate = true} = {}) {
                this.$cy.layout({name: name, randomize: randomize, animate: animate,}).run();
            },
            /***************************Â∑•ÂÖ∑Ê†è************************/
        },
    }
</script>
<style scoped>
    .tools {
        display: inline-block;
        height: 45px;
        width: 45px;
        vertical-align: middle;
    }

    .center-center {
        height: 100%;
        display: flex;
        align-items: center;
        align-content: center;
        justify-items: center;
        justify-content: center;
    }
</style>

